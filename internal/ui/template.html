{{define "commentThread"}}
  {{range .Comments}}
    <div class="line-comment">
      <img src="{{$.Logo}}" alt="Meatcheck logo" class="line-comment-avatar" />
      <div class="line-comment-content">
        <div class="line-comment-meta">{{.Path}}:{{.StartLine}}-{{.EndLine}}</div>
        {{if $.Root.RenderComments}}
          <div class="line-comment-body markdown">{{.Rendered}}</div>
        {{else}}
          <div class="line-comment-body">{{.Text}}</div>
        {{end}}
      </div>
    </div>
  {{end}}
{{end}}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meatcheck</title>
  <link rel="icon" type="image/png" href="{{.Logo}}" />
  <style>
    {{.CSS}}
  </style>
</head>
<body class="theme-dark">
  <div class="app" live-hook="line-selector">
    {{with .Assigns}}
    {{$root := .}}
    <header class="header">
        <div class="header-top">
          <img src="{{$.Avatar}}" alt="AI avatar" class="header-avatar" />
          {{if .Prompt}}
            <div class="prompt-inline">
              {{if .PromptHTML}}
                <div class="prompt-body markdown">{{.PromptHTML}}</div>
              {{else}}
                <div class="prompt-body">{{.Prompt}}</div>
              {{end}}
            </div>
          {{end}}
          <div class="header-actions">
          <button class="icon-btn {{if and (eq .Mode "file") .ViewFile.MarkdownFile}}{{if .ViewFile.MarkdownRendered}}active{{end}}{{else}}{{if .RenderFile}}active{{end}}{{end}}" live-click="toggle-file-render" title="{{if and (eq .Mode "file") .ViewFile.MarkdownFile}}Toggle markdown preview{{else}}Toggle file rendering{{end}}" aria-label="{{if and (eq .Mode "file") .ViewFile.MarkdownFile}}Toggle markdown preview{{else}}Toggle file rendering{{end}}">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M6 3h8l4 4v14H6z" fill="none" stroke="currentColor" stroke-width="1.5"/>
              <path d="M14 3v5h5" fill="none" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 13h2l1-2 2 4 1.2-2H16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="icon-btn {{if .RenderComments}}active{{end}}" live-click="toggle-comment-render" title="Toggle comment rendering" aria-label="Toggle comment rendering">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M5 4h14v10H8l-3 3z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
              <path d="M8 8h8M8 11h6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
          <button class="btn" live-click="finish">Finish</button>
        </div>
        </div>
    </header>

    <div class="workspace">
      <aside class="sidebar">
        {{range .Tree}}
          {{if .IsDir}}
            <div class="tree-item dir" style="margin-left: {{mul .Depth 12}}px;">{{.Name}}</div>
          {{else}}
            <div class="tree-item file {{if .Selected}}selected{{end}}" style="margin-left: {{mul .Depth 12}}px;" live-click="select-file" live-value-path="{{.Path}}">
              {{.Name}}
            </div>
          {{end}}
        {{end}}
        <div class="sidebar-brand">
          <img src="{{$.Logo}}" alt="Meatcheck logo" class="logo" />
          <span>Meatcheck</span>
        </div>
      </aside>

      <section class="main">
        <div class="column-header">
          <div class="path">{{.SelectedLabel}}</div>
        </div>
        <main class="content">
          {{if eq $root.Mode "diff"}}
  <div class="diff" id="code-view-{{.CodeViewKey}}">
    {{range .ViewDiff.Hunks}}
      <div class="hunk-header">{{.Header}}</div>
      {{range .Lines}}
        <div class="diff-line {{if .Selected}}selected{{end}} {{if .Commented}}commented{{end}}" data-line="{{.NewLine}}" data-new-line="{{.NewLine}}" data-kind="{{.Kind}}">
          <span class="ln old">{{if gt .OldLine 0}}{{.OldLine}}{{end}}</span>
          <span class="ln new" data-line="{{.NewLine}}">{{if gt .NewLine 0}}{{.NewLine}}{{end}}</span>
          <span class="diff-sign {{.Kind}}">{{if eq .Kind "add"}}+{{else if eq .Kind "del"}}-{{else}} {{end}}</span>
          <div class="code-text {{if $root.RenderFile}}chroma{{end}}">
            {{if $root.RenderFile}}{{.HTML}}{{else}}{{.Text}}{{end}}
          </div>
        </div>
        {{if .Comments}}
          <div class="line-comment-thread">
            {{template "commentThread" (commentThreadData $root .Comments $.Logo)}}
          </div>
        {{end}}
        {{if and (gt $root.SelectionEnd 0) (eq .NewLine $root.SelectionEnd) (ne .Kind "del")}}
          <div class="inline-comment">
            <form id="comment-form-{{id $root.SelectedPath}}-{{$root.SelectionEnd}}" class="comment-form" live-submit="add-comment">
              <div class="inline-meta">Selected: {{$root.SelectionStart}}-{{$root.SelectionEnd}}</div>
              <textarea name="comment" placeholder="Leave a comment..." autofocus></textarea>
              {{if $root.Error}}<div class="error">{{$root.Error}}</div>{{end}}
              <div class="comment-actions">
                <button class="btn secondary" type="button" live-click="cancel-comment">Cancel</button>
                <button class="btn" type="submit">Add Comment</button>
              </div>
            </form>
          </div>
        {{end}}
      {{end}}
    {{end}}
  </div>
{{else}}
  {{if and .ViewFile.MarkdownFile .ViewFile.MarkdownRendered}}
  <div class="markdown-file-preview markdown" id="code-view-{{.CodeViewKey}}">
    <div class="markdown-file-body">{{.ViewFile.MarkdownHTML}}</div>
    <div class="markdown-file-hint">Switch to code view to add line comments.</div>
  </div>
  {{else}}
  <div class="code {{if $root.RenderFile}}chroma{{end}}" id="code-view-{{.CodeViewKey}}">
    {{range .ViewFile.Lines}}
      <div class="line-block" id="line-{{id $root.SelectedPath}}-{{.Number}}">
        <div class="line {{if .Selected}}selected{{end}} {{if .Commented}}commented{{end}}" data-line="{{.Number}}">
          <span class="ln" data-line="{{.Number}}">{{.Number}}</span>
          <div class="code-text">{{if $root.RenderFile}}{{.HTML}}{{else}}{{.Text}}{{end}}</div>
        </div>
        {{if .Comments}}
          <div class="line-comment-thread">
            {{template "commentThread" (commentThreadData $root .Comments $.Logo)}}
          </div>
        {{end}}
        {{if and (gt $root.SelectionEnd 0) (eq .Number $root.SelectionEnd)}}
          <div class="inline-comment">
            <form id="comment-form-{{id $root.SelectedPath}}-{{$root.SelectionEnd}}" class="comment-form" live-submit="add-comment">
              <div class="inline-meta">Selected: {{$root.SelectionStart}}-{{$root.SelectionEnd}}</div>
              <textarea name="comment" placeholder="Leave a comment..." autofocus></textarea>
              {{if $root.Error}}<div class="error">{{$root.Error}}</div>{{end}}
              <div class="comment-actions">
                <button class="btn secondary" type="button" live-click="cancel-comment">Cancel</button>
                <button class="btn" type="submit">Add Comment</button>
              </div>
            </form>
          </div>
        {{end}}
      </div>
    {{end}}
  </div>
  {{end}}
{{end}}
</main>
      </section>
    </div>
    {{end}}
  </div>

  <script>
    window.Hooks = window.Hooks || {};
    window.Hooks["line-selector"] = {
      mounted: function () {
        const root = this.el;
        this.handleEvent("close-tab", () => {
          try {
            window.open("", "_self");
          } catch (e) {}
          window.close();
          setTimeout(() => {
            window.location.replace("about:blank");
          }, 50);
        });
        root.addEventListener("click", (ev) => {
          const target = ev.target;
          if (!target || !(target instanceof Element)) return;
          if (target.closest(".inline-comment, .line-comment-thread, .comment-form")) return;
          const clickable = target.closest("[data-line]");
          if (!clickable) return;
          const line = Number(clickable.dataset.line || 0);
          if (!line) return;
          const shift = ev.shiftKey ? "1" : "";
          if (window.Live && typeof window.Live.send === "function") {
            window.Live.send("select-line", { line: line, shift: shift });
          }
        });
        root.addEventListener("click", (ev) => {
          const target = ev.target;
          if (!target || !(target instanceof Element)) return;
          if (!target.matches('button[live-click="cancel-comment"]')) return;
          const form = target.closest("form");
          if (!form) return;
          const textarea = form.querySelector('textarea[name="comment"]');
          if (textarea) {
            textarea.value = "";
          }
        });
        root.addEventListener("keydown", (ev) => {
          const target = ev.target;
          if (!target || target.tagName !== "TEXTAREA") return;
          if (target.name !== "comment") return;
          if (!(ev.ctrlKey || ev.metaKey) || ev.key !== "Enter") return;
          const form = target.closest("form");
          if (!form) return;
          ev.preventDefault();
          if (typeof form.requestSubmit === "function") {
            form.requestSubmit();
          } else {
            form.submit();
          }
        });
      },
      disconnected: function () {
        try {
          window.open("", "_self");
        } catch (e) {}
        window.close();
        setTimeout(() => {
          window.location.replace("about:blank");
        }, 50);
      }
    };
  </script>
  <script defer src="/live.js"></script>
</body>
</html>
